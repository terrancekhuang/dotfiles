#!/usr/bin/env bash

# Check dependencies
which soffice &>/dev/null || {
    echo "soffice not found."
    exit 1
}
which magick &>/dev/null || {
    echo "magick not found."
    exit 1
}
which ebook-convert &>/dev/null || {
    echo "ebook-convert not found."
    exit 1
}

which pandoc &>/dev/null || {
    echo "pandoc not found."
    exit 1
}

files=("${@:1:$#-1}")
convert_to="${@: -1}"

for convert_from in "${files[@]}"; do
    [ -f "$convert_from" ] || {
        echo "$convert_from not found."
        exit 1
    }

    filename="${convert_from%.*}"
    convert_from_extension="${convert_from##*.}"

    case "$convert_to" in
    jpg | png | webp | gif)
        # Image conversion
        echo "Converting $convert_from to $filename.$convert_to"
        magick "$convert_from" "$filename.$convert_to" &&
            echo -e "\tDone." ||
            echo -e "\tConversion failed."
        ;;
    pdf)
        # Document conversion
        case "$convert_from_extension" in
        docx | doc | odt)
            echo "Converting $convert_from to $filename.pdf"
            soffice --headless --convert-to pdf "$convert_from" &&
                echo -e "\tDone." ||
                echo -e "\tConversion failed."
            ;;
        epub)
            echo "Converting $convert_from to $filename.pdf"
            ebook-convert "$convert_from" "$filename.pdf" &&
                echo -e "\tDone." ||
                echo -e "\tConversion failed."
            ;;
        md | txt)
            echo "Converting $convert_from to $filename.pdf"
            pandoc "$convert_from" -o "$filename.pdf" &&
                echo -e "\tDone." ||
                echo -e "\tConversion failed."
            ;;
        html)
            echo "Converting $convert_from to $filename.pdf"
            weasyprint "$convert_from" "$filename.pdf" &&
                echo -e "\tDone." ||
                echo -e "\tConversion failed."
            ;;
        esac
        ;;
    *)
        echo "Unsupported format: $convert_to"
        exit 1
        ;;
    esac
done
